{% extends "base.html" %}

{% block title %}
Map
{% endblock %}
{% block head %}
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.4/leaflet.css" />

<script src="http://cdn.leafletjs.com/leaflet-0.4/leaflet.js"></script>
<style>.leaflet-container{ background : #fff; }
/*make sure the viewport is 100% height*/
html, body {
    height : 100%;
}

/*make the page element 100% height*/
#map-page {
    height : 100%;
}

/*specify a height for the header so we can line-up the elements, the default is 40px*/
.ui-header {
    height : 80px;
}

/*set the content to be full-width and height except it doesn't overlap the header or footer*/
.ui-content {
    position : absolute;
    top      : 80px;
    right    : 0;
    bottom   : 0px; /*CHANGE IF USE */
    left     : 0;
    padding:0;
}

/*absolutely position the footer to the bottom of the page*/
.ui-footer {
    position : absolute;
    bottom   : 0;
    left     : 0;
    width    : 100%;
    height   : 0px; /*CHANGE IF USE */
}
#map {
height:100%;
}â€‹
</style>
<script>



$(document).ready(function() {

//http://zsprawl.com/iOS/2012/05/completely-disabling-zoom-in-jquery-mobile-1-1-0/
$(document).bind( "mobileinit", function(event) {
    $.extend($.mobile.zoom, {locked:true,enabled:false});
});

var map = L.map('map').setView([0,0], 2);

		L.tileLayer('/static/map/{z}/{x}/{y}.png', {
			maxZoom: 4,
			continuousWorld: false,
			attribution: '',
			continuousWorld: true,
			noWrap: true
			
		}).addTo(map);
		layergroup = L.layerGroup();

		layergroup.addTo(map);
		layergroup.addLayer(L.marker([20, 5]).bindPopup('a'));

		function search(query){
			
			$.post('/map/search', {q:query}, function(response) {
				layergroup.clearLayers();
				var alreadyopen=false;
				for(var id in response) {
					item=response[id];
					
					layergroup.addLayer(l=L.marker(item.pos).bindPopup("<strong>"+item.title+"</strong><br/><a href='"+item.url+"'>Website</a>"));
					if(query != "" && !alreadyopen) {
						l.openPopup();
						alreadyopen = true;
					}
				}
				$.mobile.loading( 'hide',{}); 

				if(response.length==0)
				{
					$.mobile.loading( 'show', {
						text: 'Location not found :(',
						textVisible: true,
						textonly: true,
						theme: 'e',
						html: ""
					});						
					setTimeout( $.mobile.hidePageLoadingMsg, 1500 );
				}
				
			}, 'json');
		}		
		search('');
  $("#search-form").submit(function(event) {

    /* stop form from submitting normally */
    event.preventDefault(); 
			$.mobile.loading( 'show',{}); 
    search($('#q').val());

    return false;
    });

});

</script>
{% endblock %}


{% block content %}

 <div id="map"></div>
{% endblock %}

{% block header %}
<form id="search-form" action="" data-ajax="false">

<input type="search" name="q" id="q" value="" />
</form>
{% endblock %}